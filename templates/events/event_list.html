<!-- templates/events/event_list.html -->
{% extends "base.html" %}
{% load static %}
{% load widget_tweaks %}

{% block content %}
<div class="container py-3">
    <div class="row mb-2">
        <div class="col-12">
            <h1 class="display-6 mb-1">{{ page_title }}</h1>
            <p class="lead text-muted mb-2">{{ page_description }}</p>
            <hr class="my-2">
        </div>
    </div>
    <div class="container mt-2">
        <form method="get" class="mb-2">
            <div class="row g-1 align-items-center">
                <div class="col-md-12">
                    <div class="input-group input-group-sm mb-1">
                        <input type="text" name="q" class="form-control" placeholder="Поиск по мероприятиям..." value="{{ request.GET.q|default:'' }}">
                        <button class="btn btn-primary px-3" type="submit">Найти</button>
                    </div>
                </div>
            </div>
        </form>
        <h1 class="h3 mb-2">Мероприятия</h1>
        <div class="mb-2 d-flex align-items-center gap-2">
            <div class="btn-group me-2" role="group">
                <a href="?{% if request.GET.cities %}cities={{ request.GET.cities|join:'&cities=' }}&{% endif %}{% if request.GET.genres %}genres={{ request.GET.genres|join:'&genres=' }}&{% endif %}{% if request.GET.date_from %}date_from={{ request.GET.date_from }}&{% endif %}{% if request.GET.date_to %}date_to={{ request.GET.date_to }}&{% endif %}{% if request.GET.page %}page={{ request.GET.page }}&{% endif %}view=card"
                   class="btn {% if view_type == 'card' %}btn-primary{% else %}btn-outline-primary{% endif %}">Карточки</a>
                <a href="?{% if request.GET.cities %}cities={{ request.GET.cities|join:'&cities=' }}&{% endif %}{% if request.GET.genres %}genres={{ request.GET.genres|join:'&genres=' }}&{% endif %}{% if request.GET.date_from %}date_from={{ request.GET.date_from }}&{% endif %}{% if request.GET.date_to %}date_to={{ request.GET.date_to }}&{% endif %}{% if request.GET.page %}page={{ request.GET.page }}&{% endif %}view=list"
                   class="btn {% if view_type == 'list' %}btn-primary{% else %}btn-outline-primary{% endif %}">Список</a>
            </div>
            <form method="get" class="d-inline-block m-0 p-0">
                <select name="sort" class="form-select form-select-sm" style="min-width:180px;" onchange="this.form.submit()">
                    <option value="" {% if not request.GET.sort %}selected{% endif %}>Сортировка: по умолчанию</option>
                    <option value="date" {% if request.GET.sort == 'date' %}selected{% endif %}>По дате</option>
                    <option value="price" {% if request.GET.sort == 'price' %}selected{% endif %}>По цене</option>
                    <option value="title" {% if request.GET.sort == 'title' %}selected{% endif %}>По названию</option>
                </select>
                {% for key, value in request.GET.items %}
                    {% if key != 'sort' and key != 'view' %}
                        <input type="hidden" name="{{ key }}" value="{{ value }}">
                    {% endif %}
                {% endfor %}
            </form>
        </div>
        <form method="get" class="mb-2 p-2 border rounded-3 elevation-1">
            <div class="row g-2 align-items-center">
                <div class="col-md-6 col-lg-3 d-flex flex-column">
                    <label for="{{ form.cities.id_for_label }}" class="form-label form-label-sm mb-1">Города</label>
                    {{ form.cities|add_class:'form-control form-control-sm' }}
                </div>
                <div class="col-md-6 col-lg-3 d-flex flex-column">
                    <label for="{{ form.genres.id_for_label }}" class="form-label form-label-sm mb-1">Жанры</label>
                    {{ form.genres|add_class:'form-control form-control-sm' }}
                </div>
                <div class="col-md-6 col-lg-2 d-flex flex-column">
                    <label for="{{ form.date_from.id_for_label }}" class="form-label form-label-sm mb-1">Дата от</label>
                    {{ form.date_from|add_class:'form-control form-control-sm' }}
                </div>
                <div class="col-md-6 col-lg-2 d-flex flex-column">
                    <label for="{{ form.date_to.id_for_label }}" class="form-label form-label-sm mb-1">Дата до</label>
                    {{ form.date_to|add_class:'form-control form-control-sm' }}
                </div>
                <div class="col-md-12 col-lg-2">
                    <div class="d-flex flex-column h-100">
                        <div style="height:25px;"><!-- Пустой div для компенсации высоты label --></div>
                        <button type="submit" class="btn btn-primary w-100 mt-auto">Фильтровать</button>
                    </div>
                </div>
            </div>
        </form>
    </div>
    {% if view_type == 'card' %}
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-3">
        {% for event in events %}
        <div class="col">
            <div class="card h-100 elevation-2 position-relative p-1" style="min-height:320px;">
                {% if user.is_authenticated %}
                <form method="post" action="{% url 'events:toggle_favorite' event.id %}" class="favorite-form position-absolute top-0 end-0 m-1" style="z-index:2;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-link p-0 border-0 bg-transparent">
                        {% if event.is_favorite %}
                            <span class="material-icons text-warning" style="font-size:1.5rem;">star</span>
                        {% else %}
                            <span class="material-icons text-secondary" style="font-size:1.5rem;">star_border</span>
                        {% endif %}
                    </button>
                </form>
                {% endif %}
                {% if event.image %}
                <img src="{{ event.image.url }}" class="card-img-top img-fluid" style="height:120px;object-fit:cover;" alt="{{ event.title|escape }}">
                {% else %}
                    <img src="{% static 'img/genre/' %}{{ event.genre.id }}.jpg" class="card-img-top img-fluid" style="height:120px;object-fit:cover;" alt="{{ event.title|escape }}">
                {% endif %}
                <div class="card-body d-flex flex-column p-2">
                    <h5 class="card-title mb-1" style="font-size:1.1rem;"><a href="{% url 'events:event_detail' event.pk %}">{{ event.title }}</a></h5>
                    <p class="card-text text-truncate mb-1" style="font-size:0.95rem;">{{ event.description }}</p>
                    <div class="d-flex justify-content-between align-items-center mt-auto">
                        <small class="text-muted">
                            <span class="material-icons" style="font-size: 1rem;">calendar_today</span>
                            {{ event.event_date|date:"d.m.Y" }}
                        </small>
                        <small class="text-muted">
                             <span class="material-icons" style="font-size: 1rem;">location_on</span>
                            {{ event.city }} | {{ event.genre }}
                        </small>
                    </div>
                </div>
                <div class="card-footer bg-transparent border-top-0 p-2">
                    <a href="{% url 'events:event_detail' event.id %}"
                       class="btn btn-primary btn-sm stretched-link">Подробнее</a>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="alert alert-info elevation-1">Мероприятия не найдены.</div>
        </div>
        {% endfor %}

    </div>
    {% else %}
    <div class="mt-3">
        <ul>
            {% for event in events %}
            <li>
                <h2><a href="{% url 'events:event_detail' event.pk %}">{{ event.title }}</a></h2>
                <p><strong>{{ event.city }}</strong> | {{ event.genre }} | {{ event.event_date }}</p>
            </li>
            {% empty %}
            <li>Мероприятия не найдены.</li>
            {% endfor %}
        </ul>
        {% endif %}
    </div>

    {% if is_paginated %}
    <div class="mt-3 text-center">
        {% if events.has_previous %}
        <a href="?{% if request.GET.urlencode %}{{ request.GET.urlencode }}&{% endif %}page={{ events.previous_page_number }}"
           class="btn btn-outline-primary btn-sm me-2">Назад</a>
        {% endif %}
        <span>Страница {{ events.number }} из {{ events.paginator.num_pages }}</span>
        {% if events.has_next %}
        <a href="?{% if request.GET.urlencode %}{{ request.GET.urlencode }}&{% endif %}page={{ events.next_page_number }}"
           class="btn btn-outline-primary btn-sm ms-2">Вперёд</a>
        {% endif %}
    </div>
    {% endif %}
</div>

{% endblock %}
